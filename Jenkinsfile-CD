pipeline {
    agent any
    environment {
        IMAGE_TAG = "latest" 
        DOCKER_IMAGE_BACKEND  = "nomanakram29/reactjs-flask-backend"
        DOCKER_IMAGE_FRONTEND = "nomanakram29/reactjs-flask-frontend"
    }
    stages {
        stage('Pull Images') {
            steps {
                echo "Pulling latest images from Docker Hub..."
                sh """
                    docker pull ${DOCKER_IMAGE_BACKEND}:${IMAGE_TAG} || true
                    docker pull ${DOCKER_IMAGE_FRONTEND}:${IMAGE_TAG} || true
                """
            }
        }
        // stage('Deploy via Docker') {
        //     steps {
        //         echo "Stopping existing containers..."
        //         sh """
        //             docker stop flask-backend || true
        //             docker rm flask-backend || true
        //             docker stop react-frontend || true
        //             docker rm react-frontend || true
        //         """
        //         echo "Running new containers..."
        //         sh """
        //             docker run -d --name flask-backend -p 5000:5000 \
        //                 -e FLASK_ENV=production \
        //                 -e JWT_SECRET_KEY=super-secret \
        //                 -e SECRET_KEY=super-secret \
        //                 ${DOCKER_IMAGE_BACKEND}:${IMAGE_TAG}

        //             docker run -d --name react-frontend -p 5173:5173 \
        //                 --link flask-backend:backend \
        //                 ${DOCKER_IMAGE_FRONTEND}:${IMAGE_TAG}
        //         """
        //     }
        // }
        // stage('Deploy via docker-compose') {
        //     steps {
        //         echo "Stopping existing docker-compose services (if any)..."
        //         sh "docker compose down || true"

        //         echo "Starting services via docker-compose..."
        //         sh "docker compose up -d"
        //     }
        // }

        // stage('Verify Deployment') {
        //     steps {
        //         echo "Checking running containers..."
        //         sh "docker ps --format 'table {{.Names}}\t{{.Image}}\t{{.Ports}}'"
        //     }
        // }
        stage('Deploy to Kubernetes') {
            steps {
                script {
                    withKubeConfig(
                        credentialsId: 'K8s-Token-for-Jenkins',
                        namespace: 'react-flask-app',
                        serverUrl: 'https://172.31.68.78:6443',
                        clusterName: 'kubernetes'
                    ) {
                        sh """
                            echo "Updating image tags in manifest..."
                            sed -i "s|image: nomanakram29/reactjs-flask-backend:.*|image: nomanakram29/reactjs-flask-backend:\${FINAL_TAG}|" k8s-deployment.yaml
                            sed -i "s|image: nomanakram29/reactjs-flask-frontend:.*|image: nomanakram29/reactjs-flask-frontend:\${FINAL_TAG}|" k8s-deployment.yaml

                            echo "Applying Kubernetes manifests..."
                            kubectl apply -f k8s-deployment.yaml

                            echo "Waiting for rollout to complete..."
                            kubectl rollout status deployment/react-flask-app --timeout=180s

                            echo "Deployment successful!"
                            echo "Backend Service URL:"
                            kubectl get svc flask-backend-service -n react-flask-app
                            echo "Frontend Service URL:"
                            kubectl get svc react-frontend-service -n react-flask-app
                        """
                    }
                }
            }
        }
    }
    post {
        success { echo "✅ Deployment via Docker/docker-compose/k8s Successful!" }
        failure { echo "❌ Deployment via Docker/docker-compose/k8s Failed!" }
    }
}
